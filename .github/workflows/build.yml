name: Build Lim.one

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  # ─────────────────────────────────────────────────────────
  # macOS: build → package → upload .pkg
  # ─────────────────────────────────────────────────────────
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure CMake
        run: cmake -S Limone -B build -G Xcode -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel 4

      - name: Package (.pkg)
        run: |
          mkdir -p dist
          OUT_DIR=dist BUILD_DIR=build bash scripts/make_installer_pkg.sh

      - name: Upload macOS .pkg
        uses: actions/upload-artifact@v4
        with:
          name: LimOne-macOS-pkg
          path: dist/*.pkg

      - name: Upload macOS raw artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LimOne-macOS-raw
          path: |
            build/LimOne_artefacts/Release/VST3/*.vst3
            build/LimOne_artefacts/Release/AU/*.component
            build/LimOne_artefacts/Release/Standalone/*.app

  # ─────────────────────────────────────────────────────────
  # Windows: build → package → upload .zip
  # ─────────────────────────────────────────────────────────
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup WebView2 SDK
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path webview2_sdk
          Set-Location webview2_sdk
          Invoke-WebRequest -Uri 'https://www.nuget.org/api/v2/package/Microsoft.Web.WebView2' -OutFile 'webview2.zip'
          Expand-Archive -Path 'webview2.zip' -DestinationPath '.' -Force
          Set-Location ..
          $includeDir = "${{ github.workspace }}\webview2_sdk\build\native\include"
          echo "WEBVIEW2_INCLUDE_DIR=$includeDir" >> $env:GITHUB_ENV

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S Limone -B build -G "Visual Studio 17 2022" `
            -DCMAKE_BUILD_TYPE=Release `
            -DWEBVIEW2_INCLUDE_DIR="$env:WEBVIEW2_INCLUDE_DIR"

      - name: Build
        run: cmake --build build --config Release --parallel 4

      - name: Install NSIS
        run: choco install nsis -y

      - name: Package (.zip + .exe installer)
        shell: pwsh
        env:
          BUILD_DIR: build
          OUT_DIR: dist
          BUILD_AAX: "false"
          SKIP_BUILD: "true"
        run: scripts\make_win_build_package.ps1

      - name: Upload Windows .zip
        uses: actions/upload-artifact@v4
        with:
          name: LimOne-Windows-zip
          path: dist/*.zip

      - name: Upload Windows .exe installer
        uses: actions/upload-artifact@v4
        with:
          name: LimOne-Windows-exe
          path: dist/*.exe
          if-no-files-found: warn

  # ─────────────────────────────────────────────────────────
  # Release: triggered on tag push → create GitHub Release
  # ─────────────────────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download macOS package
        uses: actions/download-artifact@v4
        with:
          name: LimOne-macOS-pkg
          path: release-assets

      - name: Download Windows .zip
        uses: actions/download-artifact@v4
        with:
          name: LimOne-Windows-zip
          path: release-assets

      - name: Download Windows .exe installer
        uses: actions/download-artifact@v4
        with:
          name: LimOne-Windows-exe
          path: release-assets
          ignore-not-found: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          assets=()
          for f in release-assets/*.pkg release-assets/*.zip release-assets/*.exe; do
            [ -f "$f" ] && assets+=("$f")
          done
          gh release create "${{ github.ref_name }}" \
            "${assets[@]}" \
            --title "Lim.one ${{ github.ref_name }}" \
            --generate-notes
